<h1>ğŸ›’ Carrito</h1>

<div id="cart-container">
  {{#if cart.products.length}}
    {{#each cart.products}}
    <div class="product-item" data-price="{{this.product.price}}" data-id="{{this.product._id}}">
      <h3>{{this.product.title}}</h3>
      <p>ğŸ’µ Precio unitario: ${{this.product.price}}</p>

      <label for="qty-{{this.product._id}}">Cantidad:</label>
      <input 
        type="number" 
        id="qty-{{this.product._id}}" 
        value="{{this.quantity}}" 
        min="1" 
        style="width: 60px; text-align: center;"
      >

      <p>Total: $<span class="product-total">{{multiply this.product.price this.quantity}}</span></p>

      <button class="update-btn">Actualizar cantidad ğŸ”„</button>
      <button class="remove-btn">Eliminar âŒ</button>
      <hr>
    </div>
    {{/each}}
  {{else}}
    <p>ğŸ•³ï¸ El carrito estÃ¡ vacÃ­o.</p>
  {{/if}}
</div>

<h2>Total general: $<span id="grand-total">{{cart.totalGeneral}}</span></h2>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const cartId = "{{cart._id}}";

    // ğŸ§® Recalcula totales del carrito
    function updateTotals() {
      let grandTotal = 0;
      const items = document.querySelectorAll(".product-item");

      items.forEach(item => {
        const price = parseFloat(item.dataset.price);
        let qty = parseInt(item.querySelector("input").value);
        if (qty < 1 || isNaN(qty)) qty = 1; // Evita cantidades menores a 1
        const total = price * qty;
        item.querySelector(".product-total").innerText = total;
        grandTotal += total;
      });

      document.getElementById("grand-total").innerText = grandTotal;

      // Si se eliminaron todos los productos, muestro mensaje
      if (items.length === 0) {
        document.getElementById("cart-container").innerHTML = "<p>ğŸ•³ï¸ El carrito estÃ¡ vacÃ­o.</p>";
        document.getElementById("grand-total").innerText = "0";
      }
    }

    // ğŸ” Inicializo totales al cargar
    updateTotals();

    // ğŸ”„ Actualizar cantidad
    document.querySelectorAll(".update-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const item = btn.closest(".product-item");
        const productId = item.dataset.id;
        const quantity = parseInt(item.querySelector("input").value);

        const res = await fetch(`/api/carts/${cartId}/products/${productId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quantity })
        });

        const data = await res.json();
        alert(data.message || "Cantidad actualizada âœ…");
        updateTotals();
      });
    });

    // âŒ Eliminar producto
    document.querySelectorAll(".remove-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const item = btn.closest(".product-item");
        const productId = item.dataset.id;

        const res = await fetch(`/api/carts/${cartId}/products/${productId}`, { method: "DELETE" });
        const data = await res.json();
        alert(data.message || "Producto eliminado âœ…");
        item.remove();
        updateTotals();
      });
    });

    // ğŸ§® Actualizar totales al cambiar cantidad manualmente
    document.querySelectorAll(".product-item input").forEach(input => {
      input.addEventListener("input", updateTotals);
    });
  });
</script>
