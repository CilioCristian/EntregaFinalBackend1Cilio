<h1 class="page-title">{{product.title}}</h1>
<!-- Muestro el título del producto -->

<div class="product-detail-container">
  <p><b>Descripción:</b> {{product.description}}</p>
  <!-- Muestro la descripción del producto -->
  <p><b>Precio:</b> ${{product.price}}</p>
  <!-- Muestro el precio del producto -->
  <p><b>Categoría:</b> {{product.category}}</p>
  <!-- Muestro la categoría del producto -->

  <!-- Botón para agregar al carrito -->
  <button onclick="addToCart('{{product._id}}')">Agregar al carrito</button>
  <!-- Al hacer clic, llamo a la función addToCart enviando el id del producto -->

  <!-- Botón para volver a la lista de productos -->
  <a href="/products" class="btn-volver">Volver al Inicio</a>
  <!-- Enlace que me lleva de vuelta a la vista de todos los productos -->
</div>

<div id="mini-cart">
  <h2>Carrito (<span id="cart-count">0</span> items)</h2>
  <!-- Contenedor del mini carrito que muestra la cantidad total de items -->
</div>

<script>
const cartId = "6910fd582b45b333a71a863b";
// Guardo el id del carrito para usarlo en las peticiones al servidor

// Función para agregar un producto al carrito
async function addToCart(productId) {
  await fetch(`/api/carts/${cartId}/products/${productId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ quantity: 1 })
  });
  // Envío el producto al servidor con cantidad 1
  renderMiniCart();
  // Vuelvo a renderizar el mini carrito para reflejar los cambios
}

// Función para renderizar el mini carrito
async function renderMiniCart() {
  const res = await fetch(`/api/carts/${cartId}`);
  const data = await res.json();
  const cart = data.payload;
  if (!cart || !cart.products) return;
  // Traigo el carrito desde el servidor y verifico que tenga productos

  let html = '';
  let grandTotal = 0;
  let totalItems = 0;
  // Inicializo variables para el total general y la cantidad total de items

  cart.products.forEach(p => {
    const total = p.product.price * p.quantity;
    grandTotal += total;
    totalItems += p.quantity;
    // Calculo el total de cada producto y sumo al total general y al total de items

    html += `
      <div class="mini-cart-item" data-id="${p.product._id}">
        <h4>${p.product.title}</h4>
        <p>Precio unitario: $${p.product.price}</p>
        <p>
          Cantidad: 
          <button onclick="updateQuantity('${p.product._id}', ${p.quantity - 1})">-</button>
          ${p.quantity}
          <button onclick="updateQuantity('${p.product._id}', ${p.quantity + 1})">+</button>
        </p>
        <p>Total: <b>$${total}</b></p>
        <button class="remove-btn" onclick="removeProduct('${p.product._id}')">Eliminar</button>
      </div>
    `;
    // Construyo el HTML de cada producto del mini carrito, incluyendo botones para aumentar, disminuir o eliminar
  });

  html += `<h3 class="grand-total">Total general: $${grandTotal}</h3>`;
  document.getElementById('mini-cart').innerHTML = html;
  document.getElementById('cart-count').innerText = totalItems;
  // Inserto el HTML en el mini carrito y actualizo el contador de items
}

// Función para actualizar la cantidad de un producto
async function updateQuantity(productId, newQty) {
  if (newQty < 1) return;
  // Evito cantidades menores a 1
  await fetch(`/api/carts/${cartId}/products/${productId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ quantity: newQty })
  });
  renderMiniCart();
  // Actualizo la cantidad en el servidor y vuelvo a renderizar el mini carrito
}

// Función para eliminar un producto del carrito
async function removeProduct(productId) {
  await fetch(`/api/carts/${cartId}/products/${productId}`, { method: "DELETE" });
  renderMiniCart();
  // Elimino el producto en el servidor y vuelvo a renderizar el mini carrito
}

window.addEventListener("DOMContentLoaded", renderMiniCart);
// Cuando la página carga, renderizo el mini carrito con los productos existentes
</script>
